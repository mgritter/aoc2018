#!/usr/bin/env stack
-- stack --install-ghc runghc --package raw-strings-qq-1.1 --package split-0.2.3.3
{-# LANGUAGE QuasiQuotes #-}
import Text.RawString.QQ
import Data.Array.Unboxed (UArray,listArray,(!))
import Data.Array.IArray (Array,listArray,(!))
import Data.Maybe (fromJust,isJust)
import Data.List (sort,find,delete)
import Data.Either (isRight,isLeft)
import Debug.Trace


input = [r|                             /-----------------------------------------------------------------\  /-----------------\                                 
                             |                 /-----------------\                             |  |                 |                                 
                             |                 | /---------------+------------\           /----+--+\          /-----+----------------------\          
                             |                 | |               |            |           |    |  ||          |     |                      |          
            /----------------+-----------------+-+<--------------+--\         |           |    |  ||          |     |                      |          
            |                |                 | |               |  |         |           |    |  ||          |     |                      |          
            |                |                 | |        /------+--+---------+-----------+----+--++----------+----\|                      |          
            |                |                 | |        |      |  |  /------+-----------+----+--++---\    /-+----++--------------------\ |          
   /--------+-\              | /---------------+-+--------+------+--+--+------+-----------+----+--++---+----+-+----++---------\          | |          
   |        | |              | |              /+-+--------+------+--+--+------+---------\ |    |  ||   |    | |    ||         |          | |          
   |   /----+-+----------\   | |              || |        |      |  |  |      |/--------+-+----+--++---+----+-+----++------\  |          | |          
   |   |    | |          |   | |         /----++-+--------+------+--+\ |      ||        | |    |  ||   |    | |    ||      |  |          | |          
   |   |    | |          |   | |         |    |\-+--------+------/  || |/-----++------\ | |    |  ||   |    | |    ||/-----+--+\         | |          
   |   |    | |          |   | |    /----+----+--+--------+\        || ||/----++------+-+-+----+--++---+----+-+----+++-----+--++---------+-+\         
   |   |  /-+-+----------+---+-+----+----+----+--+--------++--------++-+++----++------+-+-+----+--++---+-\  | |    |||     |  ||         | ||         
   |   |  | | |          |   | |    |    |    |  |        ||        || |||    ||      | | |    |/-++---+-+--+-+----+++-----+\ ||         | ||         
   |   |  | | |          |   | |    |    |    |  |        ||        || |||    ||      | | |   /++-++---+-+--+-+----+++-----++-++----\    | ||         
   |   |  | | |/---------+---+-+----+\   |    |  |        ||        || |||    ||      | | |   ||| ||   | |  | |    |||     || ||    |    | ||         
   |   |  | | ||         |   | |    ||   |    |  |        ||        ||/+++----++------+-+-+---+++-++---+-+--+-+----+++-----++-++----+--\ | ||         
   |   |  | | ||         |   | |  /-++---+----+--+--------++-----<--++++++----++------+-+-+---+++-++---+-+--+-+----+++-----++\||    |  | | ||         
   |   |  | | ||         |   | |  | ||   |    |  |        ||       /++++++----++------+-+-+---+++-++---+-+-<+-+----+++----\|||||    |  | | ||         
   |   |  | | ||         |   | |  | ||   |    |  |        ||       |||||||    ||      | | |   ||| ||   | |  | |    |||    ||||||    |  | | ||         
   |   |  | | ||         |   | |  |/++---+----+--+--------++-------+++++++----++------+-+-+---+++-++---+-+--+-+----+++----++++++----+--+-+-++\        
   |   |  | | ||     /---+---+-+--++++---+----+\ |        ||       |||||||    ||      | | |   ||| ||   | |  | |    |||    ||||||    |  | | |||        
   |   |  | | ||     |   |   | |  ||||   |    || |        ||   /---+++++++----++------+-+-+---+++-++---+<+--+-+----+++----++++++\   |  | | |||        
   |   |  | | ||     |   |   | |  ||||/--+----++-+--------++---+---+++++++----++------+-+-+---+++-++---+-+--+-+-\  |||    |||||||   |  | | |||        
   |   |  | | ||     |   |   | |  |||||  \----++-+--------++---+---++/||||    ||      | | |   ||| ||   | |  | | |  |||    |||||||   |  | | |||        
   \---+--+-+-/|  /--+---+---+-+--+++++-------++-+--------++---+---++-++++----++------+-+-+---+++-++\  | |  | | |  |||    ||||||| /-+--+-+-+++\       
       |  | | /+--+--+---+---+-+--+++++-------++-+--------++---+---++-++++----++------+-+-+---+++-+++--+-+--+-+-+--+++-\  ||||||| | |  | | ||||       
       |  | | ||  |  |   |   | |  |||||   /---++-+--------++---+---++-++++----++------+-+-+---+++-+++--+-+-\| | |  |||/+--+++++++-+-+--+-+-++++-\     
       |  | | ||  |  |   |   | |  |||||   |   || |        ||   |   || ||||    ||   /--+-+-+-\ ||| |||  | | || | |  |||||  ||||||| | |  | | |||| |     
       |  | | ||  |  |   |   | |  |||||   |   || |        \+---+---++-++++----++---+--+-+-+-+-+++-+++--+-+-++-+-+--/||||  ||||||| | |  | | |||| |     
       |  | \-++--+--+---+---+-+--+++++---+---++-+---------+---+---+/ ||||    ||   |  | | | | ||| |||  | | || | |   ||||  ||||||| | |  | | |||| |     
       |  |   ||  |  |   |   | |  |||||   |   || |         |   |   |  ||||    ||   |  | | | | ||| |||  | | || | |   ||||  ||||||| | |  | | |||| |     
     /-+--+---++--+-\|   |   | |  |||||   |   || |         |   |   |  ||||  /-++---+--+-+-+-+-+++-+++--+-+-++-+-+---++++--+++++++-+-+-\| | |||| |     
     | |  |   ||  | ||   |   | |  |||||   |   || |       /-+---+---+--++++--+-++---+--+-+-+-+-+++-+++--+\| || | |   ||||  ||||||| | | || | |||| |     
     | |  |   ||  | ||   |   | |  |||||   |   || |       | |   |   |  ||||  | ||   |  | | | | ||| |||  ||| || \-+---++++--+++++++-+-+-++-+-/||| |     
     | |  |   ||  | ||   |   | |  |||||   |   || |       | |   |   | /++++--+-++---+--+-+-+-+-+++-+++--+++\||   | /-++++--+++++++-+-+-++-+--+++-+-<-\ 
     | |  |   ||  | ||   |   | |  ||\++---+---++-+-------+-/   |   | |||||  | ||   |  | | | | ||| |||  ||||||   | | ||||  ||||||| | | || |  ||| |   | 
     |/+--+---++--+-++---+---+-+--++-++---+---++-+-------+-----+---+-+++++--+-++---+--+-+-+-+-+++-+++--++++++\  | | ||||  ||||||| | | || |  ||| |   | 
     |||  |   ||  | ||   |   | |  || || /-+---++-+-------+-----+---+-+++++--+-++---+--+-+-+-+-+++-+++--+++++++\ | | ||||  ||||||| | | || |  ||| |   | 
     |||  |   ||  | ||   |   \-+--++-++-+-+---++-+-------+-----+---+-+++++--+-++---+--+-+-+-+-+/| |||  |||||||| | | ||||  ||||||| | | || |  ||| |   | 
     |||  |   ||  | ||   |     |  || || | |   || |       |     \---+-+++++--+-++---+--+-+-+-+-+-+-+++--++++++++-+-+-++++--++++++/ | | || |  ||| |   | 
     |||  |   ||  | ||   |     |  || || | |   || |       |       /-+-+++++\ | ||   |  | | | | | | \++--++++++++-+-+-/|||  ||||||  | | || |  ||| |   | 
     |||  |   ||  | ||   |     |  || || | |   || |       |       | | |||||| | ||   |  | | |/+-+-+--++--++++++++-+-+--+++--++++++--+-+-++-+--+++-+---+\
     |||  |   ||  | ||   |     |  || || | |/--++-+-------+-------+-+-++++++-+-++---+--+-+-+++-+\|  ||  |||||||| | |  |||  ||||||  | | || |  ||| |   ||
     |||  |   ||  | ||   |     |  || || | ||  || |       |       | | |||||| | ||   |  | | ||| |||  ||  |||||||| | |  |||  ||||||  | | || |  ||| |   ||
     |||  \---++--+-++---+->---+--++-++-+-++--++-+-------+-------+-+-++++++-+-++---+--+-+-+++-+++--++--++/||||| | |  |\+--++++++--+-+-++-+--+++-/   ||
     |||      ||  | ||   |     |  || || | ||  || |       |    /--+-+-++++++-+-++---+--+\| ||| |||  ||  || ||||| | |  | |  ||||||  | | || |  |||     ||
     |||      ||  | ||   | /---+--++-++-+-++--++-+--\    |    |  | | |||||| | ||   |  ||| ||| |||  ||  || ||||| | |  | |  ||||||  | | || |  |||     ||
     |||      ||  | ||   | |   |  || || | ||  || |  |    |    |  | | |||||| | ||   |  ||| ||| |||  ||  || ||||| | |  | |  ||||||  | | || |  |||     ||
     |||      ||  | ||   | |   |  || || | ||  || |  |    |    |  | | |||||| | ||   |/-+++-+++-+++-\||  || ||||| | |  | |  ||||||  | | || |  |||     ||
     |||      ||  | ||   | |   |  || || | ||  \+-+--+----+----+--+-+-++++++-+-++---++-++/ ||| ||| |||  || ||||| | |  | |  ||||||  | | || |  |||     ||
     |||      ||  | ||   | |   |  || || | ||/--+-+--+--\ |    |  | | |||||| | ||   || ||  ||| ||| |||  || ||||| | |  | |  ||||||  | | || |  |||     ||
     |||      ||  | ||   | |   |  || || | |||  | |  |  | |    |  | | ||\+++-+-++---++-++--+++-+++-+++--/| ||||| | |  |/+--++++++\ | | || |  |||     ||
     |||      ||  | ||   | |   |  || ||/+-+++--+-+--+--+-+----+--+-+-++-+++-+-++---++-++--+++-+++-+++---+-+++++\| |/-+++--+++++++-+-+-++-+--+++\    |v
 /---+++------++--+-++---+-+---+--++\|||| |||  | |  |  | |    |  | | || ||| | |\---++-++--+++-+++-+++---+-+++++++-++-+++--+/||||| | | || |  ||||    ||
 |   |||/-----++--+-++---+-+-\ |  ||||||| |||  | |  |  |/+----+--+-+-++-+++-+-+----++-++--+++-+++-+++---+-+++++++-++-+++-\| ||||| | |/++-+--++++-\  ||
 |   ||||     ||  | ||   | | | |  ||||||| |||  | |  |  |||    |  | | || |||/+-+----++-++--+++-+++-+++---+-+++++++-++\||| || ||||| | |||| |  |||| |  ||
 |   ||||     ||  | ||   | | | |/-+++++++-+++--+-+--+--+++----+--+-+-++-+++++-+----++-++--+++\||| |||   | ||||||| |||||| || ||||| | |||| |  |||| |  ||
 |   ||||     ||  | ||   | | | || ||||||| |||  | |  |  |||    |  | | || ||||| |    || ||  \++++++-+/|   | ||||||| |||||| || ||||| | |||| |  |||| |  ||
 |   ||||     ||  | ||   | | | || ||||||| |||  | |  |  |||    |  | \-++-+++++-+----++-++---++++++-+-+---+-+++++++-++++++-+/ ||||| | |||| |  |||| |  ||
 |   ||||     ||  | ||   | | | || ||||||| |||  | |  |  |||    \--+---++-+++++-+----++-+/   |||||| | |   | ||||||| |||||| |  |||^| | |||| |  |||| |  ||
 |   ||||     ||  | ||   | | | || ||||||| |||  | | /+--+++-------+---++-+++++-+---\|| |    |||||| | |   | ||||||| \+++++-+--+++++-+-++++-+--++++-+--/|
 |   ||||     ||  | ||   | | | || ||||||| |||  | | ||  |||       |   || ||||| |   ||| |    |||||| | |   | ||\++++--+++++-+--+++++-+-++++-/  |||| |   |
 |   ||||     ||  | ||   | | |/++-+++++++-+++--+-+-++--+++-------+---++-+++++-+---+++-+----++++++-+-+->-+-++-++++--+++++-+--+++++-+-++++--\ |||| |   |
 |   ||||     ||  | ||   | | |^|| ||||||| |||  | | ||  |||       |   || ||||| |   ||| |    |||||| | |   | || ||||  ||||| |  ||||| | ||||  | |||| |   |
 |   ||||     ||  | ||   | | |||| ||||||| |||  | | ||  |||       |   || ||||| |   ||| |    |||||| | |   | || ||||  |||\+-+--++++/ | ||||  | |||| |   |
 |   ||||     ||  | ||   | | |||| ||||||| |||  | | ||  |||      /+---++-+++++-+---+++-+----++++++-+-+---+-++-++++--+++-+-+--++++--+-++++-\| |||| |   |
 |   ||||     ||  | ||   | | |||| ||||||| |||  | | ||  |||      ||   || ||||| |   ||| |    |||||| | |   | || ||||  ||| | |  ||||  | |\++-++-++++-/   |
 |   ||||/----++--+-++---+-+-++++-+++++++-+++--+-+-++--+++------++\  || ||||| |   ||| |    |||||| | |   | || ||||  \++-+-+--++++--+-+-++-++-+++/     |
 |   ||\++----++--+-++---/ | |||| |||||||/+++--+-+-++--+++------+++--++-+++++-+---+++-+----++++++-+-+---+-++-++++---++-+-+--++++--+-+-++-++-+++\     |
 |/--++-++----++--+-++-----+-++++-+++++++++++--+-+-++--+++------+++--++-+++++-+---+++-+----++++++-+-+-\ | || ||||   || | |  ||||  | | || || ||||     |
 ||  |\-++----++--+-++-----+-++++-+++++++++++--+-+-++--+++------+++--++-+++++-+---+++-+----++++++-+-+-+-+-++-/|||   || | |  ||||  | | ||/++-++++----\|
 || /+--++----++-\| ||     | ||\+-+++++++++++--+-+-++--+++------+++--++-+++++-+---+++-+----++++++-+-+-+-+-++--+++---++-+-+--++/| /+-+-+++++\||||    ||
 || ||  ||    || || ||     | || | |||||||||||  | | ||  |||      |||  || ||||| |   ||| |    |||||| | | | | ||  |||   || | |  || | || | ||||||||||    ||
 || ||  ||    || || ||    /+-++-+-+++++++++++--+-+-++--+++------+++-\|| ||||| |   ||| |    |||||| |/+-+-+-++--+++---++-+-+--++-+-++-+-++++++++++-\  ||
 || ||  ||    ||/++-++----++-++-+-+++++++++++--+-+-++--+++------+++-+++-+++++-+---+++-+\   |||||| ||| | | ||  |||   || | |  || | || | |||||||||| |  ||
 || ||  ||    ||||| ||    || || | ||||||||\++--+-+-++--+++------+++-+++-+++++-+---+++-++---++++++-+++-+-+-+/  |||   || | |  || | || | |||||||||| |  ||
 || ||  ||    ||||\-++----++-++-+-++++++++-++--+-+-++--+++------+++-+++-+++++-+---+++-++---++++++-++/ | | |   |||   |\-+-+--++-/ || | |||||||||| |  ||
 || ||  ||    ||||  ||    || || | |||||||| ||  | | ||  |||      ||| ||| \++++-+---+++-/|   |||||| ||  | | |   |||   |  | |  ||   || | |||||||||| |  ||
 || ||  ||    ||||  ||    || || | |||||||| ||  | \-++--+++------+++-+++--++++-/   |||  |/--++++++\||  | | | /-+++---+--+-+--++---++-+-++++++++++-+-\||
 || ||  ||    ||||  ||    || || | |||||||| \+--+---++--+++------+++-+++--++++-----+++--++--++++/||||  | | | | |||   |  | |  ||   || | |||||||||| | |||
 || ||  ||    ||||  ||    || || | ||||||||  |  |   ||  |||      ||| |||  ||||     |||  ||  |||| ||||  | | | | |||   |  | |  ||   || | |||||||||| | |||
 || ||  ||    |||| /++----++-++-+-++++++++--+--+---++--+++------+++-+++--++++-----+++--++\ |||| ||||  | | | | |||   |  | |  ||   || | |||||||||| | |||
 || ||  ||    |||| |||    || || | ||||||||  |  |   ||  ||| /----+++-+++--++++-----+++--+++-++++-++++--+-+-+-+-+++---+--+-+--++---++-+-++++++++++-+\|||
 || ||  ||    |||| ||\----++-++-+-++++++++--+--/   ||  ||| |    |\+-+++--+/\+-----+++--+++-++++-++++--+-+-+-+-+++---/  | |  ||   || | |||||||||| |||||
 || ||  ||    |||| ||     || || | |\++++++--+------++--+++-+----+-+-+++--+--+-----+++--+++-++++-++++--+-+-+-+-+++------+-+--++---++-+-+++++++/|| |||||
 || ||  ||    |||| ||     || || | | ||\+++--+------++--+++-+----+-+-+++--+--+-----+++--+++-++++-++++--+-+-+-+-++/      | |  ||   || | ||||||| || |||||
 || ||  ||    |||| ||     || || | | || |||  |      ||  ||| |    | | |||  |  |     |||  ||| |||| ||||  | | | | ||       | |  ||   || | ||\++++-++-+++/|
 || ||  ||    |||| ||/----++-++-+-+-++-+++--+------++--+++-+----+-+-+++--+--+--\  |||  ||| |||| ||||  | | | | ||      /+-+--++--\|| | || |||| || ||| |
/++-++--++----++++-+++----++-++-+-+-++-+++-\|      ||  ||| |    | | ||\--+--+--+--+++--+++-++++-++++--+-+-+-+-++------++-+--++--+++-+-+/ |||| || ||| |
||| ||  ||  /-++++-+++----++-++-+-+-++-+++-++\     ||  ||| |    | | ||   |  |  |  |||  ||| |||| ||||  | | | | ||      || |  ||  ||| |/+--++++-++-+++\|
||\-++--++--+-++++-+++----++-++-+-+-++-+++-+++-----++--+++-+----+-+-++---+--+--+--+++--+++-++++-++++--/ | | | ||      || |  ||  ||| |||  |||| || |||||
||  ||  ||  | |||| |||    || || | | || ||| |||     ||  ||| |    \-+-++---+--+--+--+++--+++-++++-++++----+-+-+-++------++-+--++--+++-+++--/||| || |||||
||  |\--++--+-++++-+/|    || || | | || ||| |||     ||  ||| |      | ||   \--+--+--+++--+++-++++-++++----+-+-+-++------++-+--++--+++-+++---++/ || |||||
||  |   ||  | |||| | |    || || | | || ||| |||     ||  ||| |      | ||  /---+--+--+++--+++-++++-++++----+-+-+-++------++-+--++--+++-+++-\ ||  || |||||
||  |   ||  | |||| | |    || || | | || ||| |||     ||  ||| |      | ||  |   |  |  ||\--+++-++++-++/|    | | | ||      || |  ||  ||| ||| | ||  || |||||
|\--+---++--+-++++-+-+----++-++-+-+-/| ||| |||     ||  ||| |      | ||  |   |  |  ||   ||| |||| || |    | | | ||      || |  ||  ||| ||| | ||  || |||||
|   |  /++--+-++++-+-+----++-++-+\|  | ||| |||     ||  ||| |      |/++--+---+--+--++---+++\|||| || |    | | | ||      || |  ||  ||| ||| | ||  || |||||
|   |  |||  | |||| | |    || || |||  | ||| |||     ||  ||| |      ||||  |   |  |  ||   |||||||| || |    | | | ||      || |  ||  ||| ||| | ||  || |||||
|   |  |||  | |||| | |    || || |||  | ||| |||     ||  ||| |      ||||  |   |  |  ||   |||||||| || |    | | | ||      || |  ||  ||| ||| | ||  || |||||
|   |  |||  | |||| | |    || || |||  | ||| |||     ||  ^|| |      ||||  |   |  | /++---++++++++-++-+----+-+-+-++--\   || |  ||  ||| ||| | ||  || |||||
|   \--+++--+-+++/ | |    || || |||  | ||| |||     ||  ||| |      ||||  |   |  | |||   |||||||| || |    | | | ||  |   || |  ||  ||| ||| | ||  || |||||
|      |||  | |||  | |    ||/++-+++--+-+++-+++-----++--+++-+------++++--+---+--+-+++---++++++++-++-+----+-+-+-++--+---++-+--++--+++\||| | ||  || |||||
|      |||  | |||/-+-+----+++++-+++--+-+++-+++----\||  ||| |      ||||  |   |  | |||   ||||\+++-++-+----+-+-+-++--+---++-+--++--+++++++-+-++--++-++++/
|      |||  | |||| | |    |||||/+++--+-+++-+++----+++--+++-+------++++--+---+--+-+++---++++-+++-++-+----+-+-+-++--+---++\|  ||  ||||||| | ||  || |||| 
|      |||  | |||| | |    \++++++++--+-+++-+++----+++--+++-+------++/|  |   |  | |||   |\++-+++-+/ |    | |/+-++--+-\ \+++--++--/|||||| | ||  || |||| 
|      |||  | |||| | |     ||||||||  | ||| |||    |||  ||| |      || |  |   |  | |||   |/++-+++-+--+----+-+++-++--+-+--+++\ ||   |||||| | ||  || |||| 
|      |||  | |||| | |     |||||||\--+-+++-+++----+++--+++-+------++-+--+---+--+-+++---++++-+++-+--+----+-+++-++--+-+--++++-+/   |||||| | ||  || |||| 
|      |||  | |||| | |     |||||||   | |\+-+++----+++--+++-+------++-+--+---+--+-+++---++++-+++-+--+----+-+++-/|  | |  |||| |    \+++++-+-+/  || |||| 
|      |||  | |||| \-+-----+++++++---+-+-+-+++----+++--+++-+------++-+--+---+--+-+++---++/| ||| |  \----+-+++--+--+-+--++++-+-----+++++-+-+---++-/||| 
|      |||  | ||\+---+-----+++++++---+-+-+-+++----+++--+++-+------++-+--+---+--+-+++---/| | ||| \-------+-+++--+--+-+--++++-/     ||||| | |   ||  ||| 
|      |||  | || | /-+-----+++++++--\| | | |\+----+++--/|\-+------++-+--+---+--+-+++----+-+-+++---------/ |||  |  | |  ||||       |||||/+-+---++-\||| 
|      |||  | || | | |     |||||||  v| |/+-+-+----+++---+--+------++-+--+---+--+-+++----+-+-+++-----------+++--+--+-+\ ||||       ||||||| |   || |||| 
|      |||  | || | | |     |||||||  || ||| | |    |||  /+--+------++-+--+---+--+-+++----+-+-+++-----------+++--+-\| || ||||       ||||||| |   || |||| 
|      |||  | || | | |     |||||||  || ||| | |    |||  ||  |      || |  |   |  | |||    | | |||           |||  | || || ||||       ||||||| |   || |||| 
|      |||  | || | | |     |||\+++--++-+++-+-+----+++--++--+------++-+--+---+--+-+++----+-+-+++----<------+++--+-++-++-++++-------+++++++-/   || |||| 
|      |||  | || | | |     ||| |||  || ||| | |    |||  ||  |      || |  |   |  | |||    | | |||           |||  | || || ||||      /+++++++--\  || |||| 
|      |||  | || | | |     ||| |||  || ||| | |    |||  ||  |      || |  |   |  | |||    \-+-+++---->------+++--+-++-++-+++/      ||||||||  |  || |||| 
|      |||  | || | | |     ||| |\+--++-+++-+-+----+++--++--+------++-+--+---+--+-+++------+-+/\-----------+++--+-++-++-+++-------+++/||||  |  || |||| 
|      |||  | || | | |     ||| | |  || ||| | |    |||  ||  |      || | /+---+--+-+++------+-+--------\    |||  | || || |||       ||| ||||  |  || |||| 
|      |||  | || | |/+-----+++-+-+\ || ||| | |    |||  ||  |      || | ||   \--+-+++------+-+--------+----+++--+-++-++-+++-------+++-+/||  |  || |||| 
|      |||  | |\-+-+++-----+++-+-++-+/ ||| | |    |||  ||  |      || | ||      | |||      | |        |    |||  | || || |||       ||| | ||  |  || |||| 
|      |||  | |  | |||     ||| ^ || |  ||| | |    |||  ||  |      || | ||      | |||      | |        |    |||  | || || |||       ||| | ||  |  || |||| 
|      |||  | |  | |||     ||| | || |  |\+-+-+----+++--++--+------++-+-++------+-+++------+-+--------+----+++--+-++-+/ |||       ||| | ||  |  || |||| 
|      |||  | |  | |||     ||| | || |  | | | |    |\+--++--+------++-+-++------+-+/|      | |        |    |||  | || |  |||       ||| | ||  |  || |||| 
\------+++--+-+--+-+++-----+++-+-++-+--+-+-/ |    | |  ||  |      || | ||      | | |      | |        |    |\+--+-++-/  |||       |\+-+-++--+--/| |||| 
       |||  | |  | |||     \++-+-++-+--+-+---+----+-/  ||  |      || | |\------+-+-+------+-+--------+----+-+--+-++----+++-------+-+-+-+/  |   | |||| 
       |||  | |  | |||      || | || |  | |   |    |    ||  |      || | |       | | |      | |        |    | |  | ||    |||       | | | |   |   | |||| 
       |||  | |  | |||      || | || |  | |   |    |    ||  |      || | |       | | |      | |        |    | \--+-++----+++-------+-+-+-+---+---+-++/| 
       |||  | \--+-+++------++-+-++-+--+-+---+----+----++--+------++-+-+-------+-+-+------+-+--------+----+----+-++----/||       | | | |   |   | || | 
    /--+++--+----+-+++------++-+-++-+--+-+---+----+----++-\|      || | |       | | |      | |        |    |    | ||     ||       | | | | /-+---+-++-+\
    |  |||  |    | \++------++-+-++-/  | |   |    |    \+-++------++-+-+-------+-+-+------+-+--------+----+----+-/|     ||       | | | | | |   | || ||
    |  |||  |    |  ||      || | ||    | |   |    |     | ||      || | |       | | \------+-/        |    |    |  |     ||       | | | | | |   | || ||
    |  |||  |    |  ||      || | ||    | |   |    |     | ||      || | |       |/+--------+----------+----+----+\ |     ||       | | | | | |   | || ||
    |  ||\--+----+--++------++-+-++----+-+---+----+-----+-++------/\-+-+-------+++--------/          |    |    || |     ||       | | | | | |   | || ||
    |  \+---+----+--++------++-+-/|    | | /-+----+-----+-++---------+-+-------+++-------------------+---<+----++-+--\  ||       | | | | | |   | || ||
    |   \---+----+--++------+/ \--+----+-+-+-+----+-----+-++---------+-+-------+++-------------------+----+----++-+--+--/|       | | | | | |   | || ||
    |       |    |  ||      |     |    | \-+-+----+-----+-++---------+-+-------+++-------------------+----+----++-+--+---+--->---+-+-+-+-+-+---/ || ||
    |       |    |  |\------+-----+----+---+-+----+-----+-++---------+-+-------/|\-------------------+----+----++-/  |   |       | | | | | |     || ||
    |       \----+--+-------+-----+----+---+-/    |     \-++---------+-+--------+--------------------+----+----++----+---/       | | | \-+-+-----/| ||
    |            |  |       \-----+----+---+------+-------++---------+-+--------+--------------------+----+----++----+-----------+-/ |   | |      | ||
    |            |  |             |    |   |      |       ||         | |        |                    |    |    ||    |           |   |   | |      | ||
    \------------+--+-------------+----+---+------+-------/|         | \--------+--------------------/    |    ||    |           \---+---+-/      | ||
                 |  \-------------/    |   |      |        |         \----------+-------------------------/    ||    |               |   |        | ||
                 |                     \---+------+--------+--------------------+------------------------------/|    |               |   |        | ||
                 |                         |      |        \--------------------+-------------------------------+----+---------------+---+--------/ ||
                 \-------------------------+------/                             \-------------------------------/    |               |   \----------+/
                                           \-------------------------------------------------------------------------/               \--------------/  |]


data Direction = North | South | East | West
  deriving (Show,Eq)

data Turn = TurnRight | Straight | TurnLeft
  deriving (Show,Eq)

data Cart = Cart Int Int Direction Turn
  deriving (Show)

instance Eq Cart where
  (==) (Cart x y _ _ ) (Cart x' y' _ _ ) = (x == x') && (y == y')
  
instance Ord Cart where
  compare (Cart x y _ _) (Cart x' y' _ _)
    | y == y' = compare x x'
    | otherwise = compare y y'
  
type Tracks = Array Int (UArray Int Char)

track '-' = True
track '|' = True
track '\\' = True
track '/' = True
track '+' = True
track ' ' = True
track _ = False

cart '>' = Just East
cart '<' = Just West
cart 'v' = Just South
cart '^' = Just North
cart _ = Nothing

cartRepl '>' = '-'
cartRepl '<' = '-'
cartRepl 'v' = '|'
cartRepl '^' = '|'


parseRow :: Int -> [Char] -> ([Cart],UArray Int Char)
parseRow y cs = parseChar 0 cs [] [] where
  parseChar x [] rs ts = (rs, listArray (0,x-1) ts) :: ([Cart],UArray Int Char)
  parseChar x (c:cs) rs ts | track c =
                               parseChar (x+1) cs rs ( ts ++ [c] )
  parseChar x (c:cs) rs ts | isJust . cart $ c =
                               let cart' = Cart x y (fromJust . cart $ c) TurnLeft
                                   tracks' = ts ++ [cartRepl c] in
                                 parseChar (x+1) cs (cart':rs) tracks'

parseInput :: String -> ([Cart],Tracks)
parseInput txt = (carts, listArray (0,numRows-1) rows) where
  allCartsAndRows = map (uncurry parseRow) (zip [0..] (lines txt))
  carts = concat (map fst allCartsAndRows)
  rows = map snd allCartsAndRows
  numRows = (length rows)

nextY :: Direction -> Int -> Int
nextY North = subtract 1
nextY South = (+1)
nextY East = (+0)
nextY West = (+0)

nextX :: Direction -> Int -> Int
nextX North = (+0)
nextX South = (+0)
nextX East = (+1)
nextX West = subtract 1

move :: Cart -> Cart
move (Cart x y d t) = Cart (nextX d x) (nextY d y) d t

turn :: Char -> Cart -> Cart
turn '|' c = c
turn '-' c = c
turn '/' (Cart x y North t) = Cart x y East t
turn '/' (Cart x y South t) = Cart x y West t
turn '/' (Cart x y East t) = Cart x y North t
turn '/' (Cart x y West t) = Cart x y South t
turn '\\' (Cart x y North t) = Cart x y West t
turn '\\' (Cart x y South t) = Cart x y East t
turn '\\' (Cart x y East t) = Cart x y South t
turn '\\' (Cart x y West t) = Cart x y North t
turn '+' (Cart x y North TurnLeft) = Cart x y West Straight
turn '+' (Cart x y North Straight) = Cart x y North TurnRight
turn '+' (Cart x y North TurnRight) = Cart x y East TurnLeft
turn '+' (Cart x y South TurnLeft) = Cart x y East Straight
turn '+' (Cart x y South Straight) = Cart x y South TurnRight
turn '+' (Cart x y South TurnRight) = Cart x y West TurnLeft
turn '+' (Cart x y East TurnLeft) = Cart x y North Straight
turn '+' (Cart x y East Straight) = Cart x y East TurnRight
turn '+' (Cart x y East TurnRight) = Cart x y South TurnLeft
turn '+' (Cart x y West TurnLeft) = Cart x y South Straight
turn '+' (Cart x y West Straight) = Cart x y West TurnRight
turn '+' (Cart x y West TurnRight) = Cart x y North TurnLeft

charAtCart :: Tracks -> Cart -> Char
charAtCart t (Cart x y _ _ ) = ( t ! y ) ! x

timeStep :: Tracks -> Cart -> Cart
timeStep ts c =
  let c' = (move c) in
    turn (charAtCart ts c') c'

type Collision = Cart
type Tick = Either [Cart] Collision

tick :: Tracks -> Tick -> Tick
tick ts (Right x) = (Right x)
tick ts (Left rs) = moveCarts (sort rs) [] where
--  moveCarts [] rs | trace (show rs) False = undefined
  moveCarts [] rs = (Left rs)
  moveCarts (a:as) rs = let r = timeStep ts a in        
--    if trace ((show r) ++ " in " ++ (show (as ++ rs))) r `elem` (as ++ rs)
    if r `elem` (as ++ rs)
    then (Right r)
    else moveCarts as (r:rs)

tick2 :: Tracks -> [Cart] -> [Cart]
tick2 ts rs = moveCarts (sort rs) [] where
  moveCarts [] rs = rs
  moveCarts (a:as) rs = let r = timeStep ts a in        
    if r `elem` (as ++ rs)
    then moveCarts (delete r as) (delete r rs)
    else moveCarts as (r:rs)

firstCollision tracks carts =
  find (isRight . snd) timeline where
  timeline = zip [0..] (iterate (tick tracks) (Left carts))

lastCart tracks carts =
  find (null . tail . snd) timeline where
  timeline = zip [0..] (iterate (tick2 tracks) carts)
  
testInput = [r|/->-\        
|   |  /----\
| /-+--+-\  |
| | |  | v  |
\-+-/  \-+--/
  \------/   |]

main :: IO ()
main = let pi = parseInput input
           carts = fst pi
           tracks = snd pi in
  putStrLn (show (sort carts)) >>
  putStrLn (show (firstCollision tracks carts)) >>
  putStrLn (show (lastCart tracks carts))
  
